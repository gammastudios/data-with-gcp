# BQ Mart with dbt
Data mart using dbt to manage the data flow from GCP object storage to target mart tables.

Packages and tools used:
* python 3.9
* VSCode
* jupyterlab

[dbt BigQuery setup docs](https://docs.getdbt.com/docs/core/connect-data-platform/bigquery-setup):
detailed information on configuring dbt with BigQuery.

## Environment Setup
Install the `dbt-bigquery` python package using poetry.
```
poetry env use 3.9
poetry add dbt-bigquery
poetry install
poetry shell
```

*Bonus* List the packages used by `dbt-bigquery`
```
poetry show dbt-bigquery
```

Configure VSCode to use the poetry python environment.  The location of the python virtual env can be
found using the python env info command.
```
poetry env info --path
```

## log into GCP using gcloud auth
Log into GCP using the gcloud cli OAuth authentication following the browser prompts to complete the login process.
```
gcloud auth login
```

## initialise a dbt project
When starting a new dbt project, the dbt cli can be used to create the dbt project skeleton.
From the `bq-mdbt-mart` directory run `dbt init` and follow the prompts.
- project name: bq_dbt_mart
- database: bigquery
- auth: oauth
- project: GCP BQ project
- dataset: BQ default dataset
- threads: 1
- job exec timeout: 300
- location: EU (will change to aus manually)

## dbt profiles.yml setup
dbt uses a profile config file for global configuration options and data source setup.  This file usually
sits outside of the project directory and NOT checked into the project git repository to protect secrets
and credentials.

The `dbt init` command will create a default `profiles.yml` file.

The default location for the dbt profiles.yml file is `~/.dbt/profiles.yml`

[dbt profiles.yml docs](https://docs.getdbt.com/docs/core/connect-data-platform/connection-profiles#advanced-customizing-a-profile-directory): detailed information on configuring the dbt
profiles.

Update the dbt `profiles.yml` file created by `dbt init` to align with the `./sample-files/sample-profiles.yml` file.
The sample profile makes the following changes to the default file generated by dbt.
* uses env var for the BQ dataset prefix appended to dataset names
* changes location to australia-southeast1 (sydney)
* uses env var for the GCP default project

Note that the `.gitignore` file has an ignore rule for `env` files to guard against commiting sensitive information
into the git repository.
* update the env file with the gcp project and default data set values
* source the env file to activate the environment `source ./bq-dbt-mart.env`

## validate dbt access to BQ
Use the `dbt debug` command to validate the configuration of the dbt project and authentication with GCP.
* Go to the dbt project directory `cd ./bq_dbt_mart`
* run `dbt debug` . If the environment is configured correctly the dbt cli command should return successfully.
```All checks passed!```