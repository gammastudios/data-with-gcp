# Setting up the environment

## Pre-requisites
* python 3.9 environment installed
* poetry installed
* VSCode installed
* gcloud cli installed
* user account provisioned in GCP with access to the datamart project.


## configure environment
1.  In a terminal sessoin (iTerm2 or VSCode terminal) go to the `./bq-dbt-mart` directory.

2.  Install python packages and start poetry shell.
```
poetry env use 3.9
poetry install
poetry shell
```
3.  (recommended) Configure VSCode python environment to use the poetry virtualenv. 

Open command pallet or select `Shift + Command + P => Python: Select Interpreter`
Set to the poetry managed python env.  If not listed, the path to the python env can be found using:
```
poetry env info --path
```

4. Use the gcloud cli to log into GCP using the interactive browser login and select the bq datamart project.
```
gcloud auth login
```

5.  Source the bq datmart env vars.  Copy the `sample-bq-dbt-mart.env` file to a file names `bq-dbt-mart.env`
and update the env var values for the dbt BQ working environment.
For the schema prefix, use a pattern such as `firstname[0:2] + lastname[0:2]`.
This is a prefix token that dbt will add the BQ schemas in the personal dev environment.
Source the env file to set the env vars
```
source ./.bq-dbt-mart.env
```

6.  Initialise a dbt project
When starting a new dbt project, the dbt cli can be used to create the dbt project skeleton.
From the `bq-mdbt-mart` directory run `dbt init` and follow the prompts.
- project name: bq_dbt_mart
- database: bigquery
- auth: oauth
- project: GCP BQ project
- dataset: BQ default dataset
- threads: 1
- job exec timeout: 300
- location: EU (will change to aus manually)

7. dbt profiles.yml setup
dbt uses a profile config file for global configuration options and data source setup.  This file usually
sits outside of the project directory and NOT checked into the project git repository to protect secrets
and credentials.

The `dbt init` command will create a default `profiles.yml` file.

The default location for the dbt profiles.yml file is `~/.dbt/profiles.yml`

[dbt profiles.yml docs](https://docs.getdbt.com/docs/core/connect-data-platform/connection-profiles#advanced-customizing-a-profile-directory): detailed information on configuring the dbt
profiles.

Update the dbt `profiles.yml` file created by `dbt init` to align with the `./sample-files/sample-profiles.yml` file.
The sample profile makes the following changes to the default file generated by dbt.
* uses env var for the BQ dataset prefix appended to dataset names
* changes location to australia-southeast1 (sydney)
* uses env var for the GCP default project

Note that the `.gitignore` file has an ignore rule for `env` files to guard against commiting sensitive information
into the git repository.
* update the env file with the gcp project and default data set values
* source the env file to activate the environment `source ./bq-dbt-mart.env`

7.  Validate dbt access to BQ
Use the `dbt debug` command to validate the configuration of the dbt project and authentication with GCP.
* Go to the dbt project directory `cd ./bq_dbt_mart`
* run `dbt debug` . If the environment is configured correctly the dbt cli command should return successfully.
```All checks passed!```
